pipeline {
    agent any

    environment {
        // Asegúrate de reemplazar este valor con tu URL de webhook de Microsoft Teams real
        // BANORTE_TOKEN = "banorte_token"
        // Agregando la nueva variable sandbox
        SANDBOX = "andres.yordan@test.jenkins"
    }

    stages {
        stage('Inicio de Despliegue') {
            steps {
                script {
                    // Notificar inicio de despliegue en Microsoft Teams
                   // def startMessage = "{\"text\":\"Inicio del despliegue del delta de componentes entre las ramas: Origen: ${env.ghprbSourceBranch} y Destino: ${env.ghprbTargetBranch}.\"}"
                    //sh "curl -H 'Content-Type: application/json' -d '${startMessage}' ${env.BANORTE_TOKEN}"
                }
            }
        }
        stage('Ejecutar Script Deploy') {
            steps {
                script {
                    // Define la ruta al script de shell, los argumentos y ejecuta el comando
                    def scriptPath = '/var/jenkins_home/scriptDeployBanorte.sh'
                    def origen = env.ghprbSourceBranch
                    def destino = env.ghprbTargetBranch
                    def sandbox = env.SANDBOX
                    // Ahora se incluye sandbox como tercer argumento
                    def comando = "bash ${scriptPath} ${origen} ${destino} ${sandbox}"
                    sh(comando)
                }
            }
        }
    }
    post {
        success {
            script {
                // Notificar éxito en Telegram
                // def successMessageTelegram = "Despliegue completado exitosamente!"
                // sh "bash /var/jenkins_home/sendTelegramMessage.sh '${successMessageTelegram}'"
                
                // Notificar éxito en Microsoft Teams
                // def successMessageTeams = "{\"text\":\"Despliegue completado exitosamente!\"}"
                // sh "curl -H 'Content-Type: application/json' -d '${successMessageTeams}' ${env.BANORTE_TOKEN}"
            }
        }
        failure {
            script {
                // Notificar fallo en Telegram
                // def failureMessageTelegram = "Despliegue fallido. Revisa los logs para más detalles."
                // sh "bash /var/jenkins_home/sendTelegramMessage.sh '${failureMessageTelegram}'"
                
                // Notificar fallo en Microsoft Teams
                // def failureMessageTeams = "{\"text\":\"Despliegue fallido. Revisa los logs para más detalles.\"}"
                //sh "curl -H 'Content-Type: application/json' -d '${failureMessageTeams}' ${env.BANORTE_TOKEN}"
            }
        }
    }
}
